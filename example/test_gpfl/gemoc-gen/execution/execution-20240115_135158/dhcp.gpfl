PROLOGUE
	AUTOMATA "DHCP incoming controller"
		init = "0"
		"0" -"Disc" -> "1" 
		"1" -"Req" -> "2" 
		"1" -"Rej" -> "2" 
		"2" -"Ack" -> "0" 
		"0" -"Rel" -> "3"
		"3" -"Ack" -> "0" 
	INIT  
		newAutomaton("DHCP incoming controller", #A)
		set(ignoredPktCnt, 0)
		set(ignoredPktThreshold, 5)
		newInterrupt(60, true, 
			set(ignoredPktThreshold, 0)
		) 

FILTER
	cond(_inPort == inSide,  
		cond(($pktType == "Ack") & ($clientId == currentClient),
			step(#A, Ack, nop)
			set(currentClient, "") 
		) 
		accept
	) 
	cond( _inPort == outSide,
		cond($pktType == "Disc", 
			step(#A, Disc, 
				set(ignoredPktCnt, ignoredPktCnt+1) 
				cond(ignoredPktCnt >= ignoredPktThreshold,
					alarm("Many external messages ignored!") 
					set(ignoredPktThreshold, 0)
				)
				drop 
			) 
			set(currentClient, $clientId)
			accept
		)
		cond(($pktType == "Req") | ($pktType=="Rej"),
			cond(!($clientId == currentClient),
				set(ignoredPktCnt, ignoredPktCnt+1)
				cond(ignoredPktCnt >= ignoredPktThreshold,
					alarm("Many external messages ignored!")
					set(ignoredPktThreshold, 0)
				)
				drop
			) 
			cond ($pktType == "Req",newEventOccurence(evt,Req))
			cond ($pktType == "Rej",newEventOccurence(evt,Rej)) 
			step(#A, evt, 
				set(ignoredPktCnt, ignoredPktCnt+1)
				cond(ignoredPktCnt >= ignoredPktThreshold,
					alarm("Many external messages ignored!")
					set(ignoredPktCnt, 0)
				)
				drop 
			) 
			accept
		)
		cond($pktType == "Rel",
			step(#A, Rel,
				set(ignoredPktCnt, ignoredPktCnt+1) 
				cond(ignoredPktCnt >= ignoredPktThreshold,
					alarm("Many external messages ignored!")
					set(ignoredPktThreshold, 0)
				)
				drop
			)
			set(currentClient, $clientId)
			accept
		)
		drop
	)
	alarm("Unhandled message")
